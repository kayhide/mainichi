#! /usr/bin/env bash

# まいにちフランス語（入門編）
# https://www2.nhk.or.jp/gogaku/french/kouza/
# 放　送：月～水曜日　午前7:30～7:45
# 再放送：同日 月～水曜日　午後2:30～2:45
# 再放送：翌週 月～水曜日　午前11:00～11:15

# まいにちフランス語（応用編）
# https://www2.nhk.or.jp/gogaku/french/kouza2/
# 放送時間
# 放　送：木・金曜日　午前7:30～7:45
# 再放送：同日 木・金曜日　午後2:30～2:45
# 再放送：翌週 木・金曜日　午前11:00～11:15

# crontab -e
# 29  7   * * 1-3 /home/kayhide/bin/record-mainichi Fr1
# 29  7   * * 4-5 /home/kayhide/bin/record-mainichi Fr2

# 29  14  * * 1-3 /home/kayhide/bin/record-mainichi Fr1-2
# 29  14  * * 4-5 /home/kayhide/bin/record-mainichi Fr2-2

# 59  10  * * 1-3 /home/kayhide/bin/record-mainichi Fr1-3
# 59  10  * * 4-5 /home/kayhide/bin/record-mainichi Fr2-3

set -eu

FFMPEG="/home/linuxbrew/.linuxbrew/bin/ffmpeg"

DATE=$(date "+%Y%m%d")
URL="https://nhkradioakr2-i.akamaihd.net/hls/live/511929/1-r2/1-r2-01.m3u8"
BASE_DIR="/home/kayhide/mainichi"
PROG="$1"
LENGTH="${2:-900}"

DIR="$BASE_DIR/$PROG"
FILENAME="$DIR/$DATE.m4a"
FILENAME_ORIG="$FILENAME.orig"

mkdir -p "$DIR"

RECORDING_LENGTH=$(("$LENGTH" + 120))

echo "==== Recording $PROG $DATE ===="
echo "$FFMPEG -i $URL -to $LENGTH -c copy $FILENAME"
echo

$FFMPEG -i $URL -to $RECORDING_LENGTH -c copy "$FILENAME"

echo "==== Extracting $PROG $DATE ===="


GAP_POSES=$($FFMPEG -i "$FILENAME" -af silencedetect=noise=-60dB:2.0 -f null - 2>&1 | grep "\\[silencedetect.*\\] *silence_start:" | sed -e "s/.*: *//")
START_POS=$(echo "$GAP_POSES" | head -n 1)
START_POS="$(echo "$START_POS + 1.0" | bc)"

for pos in "${GAP_POSES[@]}"; do
    echo "$pos"
    if (( $(echo "$START_POS + $LENGTH < $pos" | bc) )); then
        END_POS=$pos
        break
    fi
done

END_POS="$(echo "$END_POS + 1.0" | bc)"
if [[ ! -z $START_POS && ! -z $END_POS ]]; then
    EXTRACTING_LENGTH=$(echo "$END_POS - $START_POS" | bc)
    mv "$FILENAME" "$FILENAME_ORIG"
    $FFMPEG -ss "$START_POS" -t "$EXTRACTING_LENGTH" -i "$FILENAME_ORIG" -c copy "$FILENAME"
fi


echo "==== Finished $PROG $DATE ===="
echo
