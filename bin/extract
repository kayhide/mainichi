#! /usr/bin/env bash

set -eu

export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
FFMPEG="ffmpeg"
BC="bc"

RAW_FILE="$1"
OUTPUT_FILE="$2"
LENGTH="${3:-900}"

GAP_POSES=$($FFMPEG -i "$RAW_FILE" -af silencedetect=noise=-60dB:2.0 -f null - 2>&1 | grep "\\[silencedetect.*\\] *silence_start:" | sed -e "s/.*: *//")

echo "Gaps are detected:"
echo "$GAP_POSES"
echo

START_POS=$(echo "$GAP_POSES" | head -n 1)
END_POS=""

for pos in ${GAP_POSES[@]}; do
    if (( $(echo "$START_POS + $LENGTH - 1 < $pos" | $BC) )); then
        END_POS=$pos
        break
    fi
done


mkdir -p "$(dirname $OUTPUT_FILE)"

if [[ ! -z $START_POS && ! -z $END_POS ]]; then
    START_POS="$(echo "$START_POS + 1.0" | $BC)"
    END_POS="$(echo "$END_POS + 1.0" | $BC)"
    EXTRACTING_LENGTH=$(echo "$END_POS - $START_POS" | $BC)
    echo "EXTRACT START_POS: $START_POS"
    echo "EXTRACT END_POS: $END_POS"
    echo "EXTRACT EXTRACTING_LENGTH: $EXTRACTING_LENGTH"
    $FFMPEG -ss "$START_POS" -t "$EXTRACTING_LENGTH" -i "$RAW_FILE" -c copy "$OUTPUT_FILE"
fi
