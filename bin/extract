#! /usr/bin/env bash

set -eu

export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
FFMPEG="ffmpeg"
BC="bc"

RAW_FILE="$1"
OUTPUT_FILE="$2"
LENGTH="${3:-900}"
OFFSET="${4:-45}"

mkdir -p tmp
GAPS_FILE=$(mktemp "tmp/${0##*/}-gaps.XXXX")
function finish {
    if [[ -e "$GAPS_FILE" ]]; then
        echo "Deleting $GAPS_FILE"
        rm -f "$GAPS_FILE"
    fi
}
trap finish EXIT

$FFMPEG -i "$RAW_FILE" -af silencedetect=noise=-60dB:1.5 -f null - 2>&1 | grep "\\[silencedetect.*\\] *silence_end" > "$GAPS_FILE"

start_pos=""
end_pos=""

echo "Gaps are detected:"
while read line; do
    gap_end=$(echo $line | sed -e "s/.* silence_end: \([0-9\.]*\).*/\1/")
    gap_duration=$(echo $line | sed -e "s/.* silence_duration: \([0-9\.]*\).*/\1/")
    gap_start=$(echo "$gap_end - $gap_duration" | $BC)
    if [[ -z $start_pos ]] && (( $(echo "$OFFSET < $gap_end" | $BC) )); then
        start_pos=$gap_end
        echo -n "* "
    elif [[ -z $end_pos ]] && (( $(echo "$start_pos + $LENGTH - 3 < $gap_start" | $BC) )); then
        end_pos=$gap_start
        echo -n "* "
    else
        echo -n "  "
    fi
    echo "$gap_start - $gap_end ($gap_duration)"
done < "$GAPS_FILE"
echo


mkdir -p "$(dirname $OUTPUT_FILE)"
[[ -e "$OUTPUT_FILE" ]] && rm "$OUTPUT_FILE"

if [[ ! -z $start_pos && ! -z $end_pos ]]; then
    start_pos="$(echo "$start_pos - 1.0" | $BC)"
    end_pos="$(echo "$end_pos + 1.0" | $BC)"
    EXTRACTING_LENGTH=$(echo "$end_pos - $start_pos" | $BC)
    echo "EXTRACT start_pos: $start_pos"
    echo "EXTRACT end_pos: $end_pos"
    echo "EXTRACT EXTRACTING_LENGTH: $EXTRACTING_LENGTH"
    echo
    $FFMPEG -ss "$start_pos" -t "$EXTRACTING_LENGTH" -i "$RAW_FILE" -c copy "$OUTPUT_FILE"
fi
